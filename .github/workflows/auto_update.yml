name: Stock Auto Update

on:
  schedule:
    # 07:00 UTC = 15:00 Taiwan Time (GMT+8)
    # Chạy từ thứ 2 đến thứ 6 hàng tuần
    - cron: '0 7 * * 1-5'
  workflow_dispatch: # Cho phép bạn bấm nút chạy thủ công bất cứ lúc nào

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write # Quan trọng: Cho phép Bot đẩy file Excel ngược lại Repo

    steps:
      # ============================================================================
      # 1. CHECKOUT CODE
      # ============================================================================
      - name: Checkout code
        uses: actions/checkout@v3

      # ============================================================================
      # 2. SETUP PYTHON ENVIRONMENT
      # ============================================================================
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip' # Cache pip dependencies for faster builds

      # ============================================================================
      # 3. INSTALL DEPENDENCIES (FIXED - Use requirements.txt)
      # ============================================================================
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ============================================================================
      # 4. DEBUG ENVIRONMENT (Optional but helpful)
      # ============================================================================
      - name: Debug environment
        run: |
          echo "Python version:"
          python --version
          echo "\nInstalled packages:"
          pip list
          echo "\nFiles in directory:"
          ls -la

      # ============================================================================
      # 5. RUN DATA COLLECTION SCRIPTS
      # ============================================================================
      - name: Run Taiwan Stock Scanner
        run: |
          python stock_tw.py
        continue-on-error: false # Fail workflow if data collection fails

      # ============================================================================
      # 6. VERIFY DATA FILES GENERATED
      # ============================================================================
      - name: Verify data files
        run: |
          echo "Checking for generated Excel files..."
          if [ -f "Taiwan_Market_Data_Latest.xlsx" ]; then
            echo "✅ Taiwan_Market_Data_Latest.xlsx generated successfully"
            ls -lh Taiwan_Market_Data_Latest.xlsx
          else
            echo "❌ Taiwan_Market_Data_Latest.xlsx not found!"
            exit 1
          fi

      # ============================================================================
      # 7. TEST DASHBOARD (Optional - Validates dashboard runs without errors)
      # ============================================================================
      - name: Test dashboard import
        run: |
          python -c "import streamlit; import pandas; import plotly; print('✅ All dashboard dependencies OK')"

      # ============================================================================
      # 8. COMMIT AND PUSH CHANGES
      # ============================================================================
      - name: Commit and Push changes
        run: |
          git config --global user.name 'Github-Action-Bot'
          git config --global user.email 'actions@github.com'
          git add *.xlsx
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update TW Market Data: $(date +'%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "✅ Data updated and pushed successfully"
          fi

      # ============================================================================
      # 9. CREATE ARTIFACT (Optional - For debugging)
      # ============================================================================
      - name: Upload Excel as artifact
        uses: actions/upload-artifact@v4
        if: always() # Upload even if previous steps fail
        with:
          name: market-data-excel
          path: '*.xlsx'
          retention-days: 7
